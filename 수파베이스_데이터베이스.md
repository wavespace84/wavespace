# 📊 WAVE SPACE 수파베이스 데이터베이스 구조 문서

> **최종 업데이트**: 2025년 9월 2일  
> **총 테이블 수**: 30개  
> **핵심 함수 수**: 33개  
> **데이터베이스 상태**: 완전 구축 완료 ✅

---

## 🎯 개요

WAVE SPACE는 부동산 영업 전문가들을 위한 종합 커뮤니티 플랫폼으로, **포인트 중심의 경제 시스템**을 통해 사용자 참여를 유도합니다. 이 문서는 비개발자도 이해할 수 있도록 데이터베이스 구조를 쉽게 설명합니다.

### 📋 시스템 분류
- **💰 포인트 관리** (5개 테이블) - 가장 중요한 핵심 시스템
- **👥 사용자 관리** (4개 테이블) - 회원 정보 및 프로필 관리
- **📅 출석 시스템** (3개 테이블) - 매일 출석체크 및 보상
- **💬 커뮤니티** (5개 테이블) - 게시글, 댓글, 좋아요, 신고
- **📢 알림 시스템** (3개 테이블) - 개인 알림 및 공지사항
- **💼 채용 시스템** (2개 테이블) - 구인구직 서비스
- **📈 자료 관리** (3개 테이블) - 시장조사서 업로드/다운로드
- **⚙️ 관리자** (3개 테이블) - 사이트 운영 및 관리
- **🏆 뱃지 시스템** (2개 테이블) - 사용자 성취 시스템

---

## 💰 포인트 관리 시스템 (최우선 핵심)

> **왜 중요한가?**: 포인트는 WAVE SPACE의 핵심 화폐로, 모든 사용자 활동과 연결됩니다. 잘못 관리되면 전체 서비스에 치명적이므로 별도의 전용 시스템으로 구축했습니다.

### 📌 point_balances (포인트 잔액 관리)
**용도**: 각 사용자의 현재 포인트 잔액을 실시간으로 관리  
**주요 정보**:
- `user_id` - 사용자 고유번호 (기본키)
- `current_points` - 현재 사용 가능한 포인트
- `total_earned` - 지금까지 총 적립한 포인트 
- `total_spent` - 지금까지 총 사용한 포인트
- `locked_points` - 임시로 잠긴 포인트 (환불 대기 등)
- `lifetime_points` - 평생 획득한 포인트 (명예용)

**연결 관계**: users 테이블과 1:1 연결  
**실제 사용 예시**: 사용자가 출석체크, 게시글 작성, 포인트 구매 시 실시간 업데이트

### 📌 point_transactions (포인트 거래 내역)
**용도**: 모든 포인트 입출금을 기록하는 장부 (절대 삭제되지 않음)  
**주요 정보**:
- `transaction_id` - 거래 고유번호 (기본키)
- `user_id` - 거래한 사용자
- `amount` - 포인트 양 (양수=적립, 음수=사용)
- `transaction_type` - 거래 종류 (earn=적립, spend=사용)
- `category` - 세부 분류 (attendance=출석, shop=상점구매, transfer=선물 등)
- `description` - 거래 설명 ("출석체크", "아이템 구매" 등)
- `balance_before` - 거래 전 잔액
- `balance_after` - 거래 후 잔액
- `created_at` - 거래 시각

**실제 사용 예시**: "2025-09-02 08:00:40에 testuser가 출석체크로 10P 적립, 잔액 500P → 510P"

### 📌 point_charges (포인트 구매/충전)
**용도**: 사용자가 실제 돈으로 포인트를 구매한 기록  
**주요 정보**:
- `charge_id` - 충전 기록 고유번호
- `user_id` - 구매한 사용자
- `charge_amount` - 결제한 실제 금액 (원)
- `points_received` - 받은 포인트
- `bonus_points` - 추가 보너스 포인트
- `payment_method` - 결제 수단 (카드, 계좌이체 등)
- `payment_status` - 결제 상태 (pending, completed, failed)
- `order_id` - 주문번호
- `toss_payment_key` - 토스페이 결제키

**실제 사용 예시**: "김철수가 10,000원으로 1,000P + 보너스 100P 구매"

### 📌 point_locks (포인트 잠금 관리)
**용도**: 특정 상황에서 포인트를 임시로 사용 불가능하게 만듦  
**주요 정보**:
- `lock_id` - 잠금 고유번호
- `user_id` - 잠금된 사용자
- `locked_points` - 잠긴 포인트 양
- `lock_reason` - 잠금 이유 ("refund_pending", "dispute" 등)
- `status` - 잠금 상태 (active, released, expired)
- `expires_at` - 잠금 만료 시각

**실제 사용 예시**: "환불 요청으로 500P 잠금 → 환불 처리 후 잠금 해제"

### 📌 point_policies (포인트 정책 설정)
**용도**: 각 활동별 포인트 지급 규칙을 설정  
**주요 정보**:
- `action_type` - 활동 종류 (attendance, post_create, comment 등)
- `points_amount` - 지급할 포인트 양
- `daily_limit` - 일일 획득 한도
- `monthly_limit` - 월간 획득 한도
- `conditions` - 추가 조건들 (JSON 형태)

**실제 사용 예시**: "출석체크 = 10P, 게시글 작성 = 5P, 댓글 작성 = 2P (1일 최대 50P)"

### 🔐 포인트 안전 함수들
**핵심 특징**: 모든 포인트 거래는 **ACID 트랜잭션**으로 처리되어 절대 오차가 발생하지 않습니다.

- **`safe_earn_points()`** - 포인트 안전 적립
- **`safe_spend_points()`** - 포인트 안전 사용 (잔액 부족시 자동 차단)
- **`safe_transfer_points()`** - 포인트 선물 (원자적 처리로 중간에 실패해도 안전)

---

## 👥 사용자 관리 시스템

### 📌 users (회원 기본 정보)
**용도**: 모든 회원의 기본 정보를 저장하는 중심 테이블  
**주요 정보**:
- `id` - 사용자 고유번호 (시스템 내부용)
- `auth_user_id` - Supabase 인증 시스템 연결용 ID
- `email` - 이메일 (로그인용, 중복 불가)
- `username` - 사용자명 (화면 표시용)
- `full_name` - 실명
- `nickname` - 별명
- `phone` - 전화번호
- `member_type` - 회원 유형 ("분양기획", "분양영업", "청약상담", "관계사", "일반")
- `is_premium` - 프리미엄 회원 여부
- `is_practitioner` - 실무자 인증 여부
- `points` - 포인트 (현재는 point_balances 사용 권장)
- `company` - 소속 회사
- `address` - 주소
- `created_at` - 회원가입 일시

**실제 사용 예시**: "김철수 (kcs@example.com), 분양영업, 프리미엄 회원, ABC공인중개사"

### 📌 profiles (추가 프로필 정보)
**용도**: 관리자 권한 등 추가 프로필 정보 저장  
**주요 정보**:
- `user_id` - 사용자 고유번호
- `role` - 역할 (admin, user 등)

### 📌 user_badges (사용자 뱃지)
**용도**: 사용자가 획득한 뱃지들을 기록  
**주요 정보**:
- `user_id` - 사용자 고유번호
- `badge_id` - 뱃지 고유번호
- `earned_at` - 획득 일시
- `method` - 획득 방법 (auto, manual, admin)

### 📌 user_sessions (세션 관리)
**용도**: 사용자 로그인 세션을 추적  
**주요 정보**:
- `session_id` - 세션 고유번호
- `user_id` - 사용자 고유번호
- `ip_address` - 접속 IP
- `user_agent` - 브라우저 정보
- `last_activity` - 마지막 활동 시각

---

## 📅 출석 시스템

### 📌 attendance_records (출석 기록)
**용도**: 매일 사용자의 출석체크를 기록  
**주요 정보**:
- `user_id` - 출석한 사용자
- `check_date` - 출석한 날짜
- `consecutive_days` - 연속 출석 일수
- `total_attendance` - 총 출석 일수
- `base_points` - 기본 출석 포인트 (보통 10P)
- `bonus_points` - 연속 출석 보너스 포인트
- `total_points` - 총 획득 포인트 (자동 계산)
- `check_time` - 출석체크 시각
- `check_method` - 출석 방법 (web, mobile, api)

**실제 사용 예시**: "김철수가 2025-09-02에 7일 연속 출석하여 10P + 보너스 20P = 30P 획득"

### 📌 attendance_rewards (출석 보상 설정)
**용도**: 연속 출석일수별 보상 규칙 설정  
**주요 정보**:
- `consecutive_days` - 연속 출석 일수
- `reward_points` - 지급할 포인트
- `special_reward` - 특별 보상 (뱃지, 아이템 등)

**실제 사용 예시**: "7일 연속 = +20P, 30일 연속 = +100P + 출석왕 뱃지"

### 📌 attendance_statistics (출석 통계)
**용도**: 사용자별 출석 통계를 집계  
**주요 정보**:
- `user_id` - 사용자 고유번호
- `total_attendance_days` - 총 출석 일수
- `current_streak` - 현재 연속 출석
- `longest_streak` - 최장 연속 출석 기록
- `this_month_attendance` - 이달 출석 일수

---

## 💬 커뮤니티 시스템

### 📌 posts (게시글)
**용도**: 커뮤니티의 모든 게시글 저장  
**주요 정보**:
- `id` - 게시글 고유번호
- `user_id` - 작성자
- `category_id` - 게시판 카테고리
- `title` - 제목
- `content` - 내용
- `view_count` - 조회수
- `like_count` - 좋아요 수
- `comment_count` - 댓글 수
- `is_featured` - 추천글 여부
- `is_private` - 비공개 여부
- `created_at` - 작성 일시

### 📌 comments (댓글)
**용도**: 게시글에 달린 댓글들 저장  
**주요 정보**:
- `id` - 댓글 고유번호
- `post_id` - 게시글 고유번호
- `user_id` - 댓글 작성자
- `parent_id` - 상위 댓글 (대댓글의 경우)
- `content` - 댓글 내용
- `like_count` - 댓글 좋아요 수
- `is_deleted` - 삭제 여부

### 📌 likes (좋아요)
**용도**: 게시글과 댓글의 좋아요 기록  
**주요 정보**:
- `user_id` - 좋아요를 누른 사용자
- `target_type` - 좋아요 대상 (post 또는 comment)
- `target_id` - 대상의 고유번호
- `created_at` - 좋아요를 누른 시각

### 📌 reports (신고)
**용도**: 부적절한 게시글이나 댓글 신고 접수  
**주요 정보**:
- `reporter_id` - 신고한 사용자
- `target_type` - 신고 대상 (post, comment, user)
- `target_id` - 대상의 고유번호
- `reason` - 신고 사유
- `description` - 상세 설명
- `status` - 처리 상태 (pending, reviewed, resolved)

### 📌 post_categories (게시판 카테고리)
**용도**: 게시판을 분류하는 카테고리 설정  
**주요 정보**:
- `id` - 카테고리 고유번호
- `name` - 카테고리 이름 ("공지사항", "자유게시판", "Q&A" 등)
- `slug` - URL용 영문 이름
- `description` - 카테고리 설명
- `post_count` - 게시글 수
- `is_active` - 활성화 여부

---

## 📢 알림 시스템

### 📌 notifications (개인 알림)
**용도**: 각 사용자에게 보낼 개인 알림 관리  
**주요 정보**:
- `user_id` - 알림받을 사용자
- `type` - 알림 종류 (point_earned, comment_reply, system 등)
- `title` - 알림 제목
- `message` - 알림 내용
- `is_read` - 읽음 여부
- `priority` - 우선순위 (high, normal, low)
- `related_table` - 관련 테이블명 (posts, comments 등)
- `related_id` - 관련 데이터의 ID

**실제 사용 예시**: "김철수님이 회원님의 게시글에 댓글을 달았습니다"

### 📌 notices (공지사항)
**용도**: 전체 회원에게 공지할 내용 관리  
**주요 정보**:
- `id` - 공지사항 고유번호
- `author_id` - 작성한 관리자
- `title` - 공지 제목
- `content` - 공지 내용
- `notice_type` - 공지 종류 (system, event, maintenance 등)
- `is_pinned` - 상단 고정 여부
- `view_count` - 조회수
- `is_published` - 게시 여부

### 📌 notice_feedbacks (공지 피드백)
**용도**: 공지사항에 대한 회원들의 반응  
**주요 정보**:
- `notice_id` - 공지사항 고유번호
- `user_id` - 피드백을 남긴 사용자
- `feedback_type` - 피드백 종류 (like, helpful, report 등)
- `comment` - 의견

---

## 💼 채용 시스템

### 📌 job_posts (채용 공고)
**용도**: 부동산 업계 채용 공고 관리  
**주요 정보**:
- `id` - 채용공고 고유번호
- `company_id` - 채용 회사
- `title` - 채용 제목
- `job_type` - 직종 ("분양기획", "분양영업" 등)
- `employment_type` - 고용형태 (정규직, 계약직, 파트타임)
- `experience_level` - 경력 요구사항
- `salary_min` - 최소 급여
- `salary_max` - 최대 급여
- `location` - 근무 지역
- `description` - 상세 설명
- `requirements` - 자격 요건
- `benefits` - 복리후생
- `application_deadline` - 지원 마감일
- `view_count` - 조회수
- `application_count` - 지원자 수

### 📌 job_applications (지원서)
**용도**: 채용 공고에 지원한 지원서 관리  
**주요 정보**:
- `id` - 지원서 고유번호
- `job_post_id` - 지원한 채용공고
- `applicant_id` - 지원자
- `resume_file_url` - 이력서 파일 링크
- `cover_letter` - 자기소개서
- `status` - 지원 상태 (applied, reviewing, interview, hired, rejected)
- `applied_at` - 지원 일시

---

## 📈 시장조사 자료 시스템

### 📌 market_research_uploads (업로드 자료)
**용도**: 회원들이 업로드한 시장조사서와 제안서 관리  
**주요 정보**:
- `id` - 자료 고유번호
- `uploader_id` - 업로드한 사용자
- `approver_id` - 승인한 관리자
- `title` - 자료 제목
- `description` - 자료 설명
- `file_name` - 파일명
- `file_size` - 파일 크기
- `file_url` - 파일 다운로드 링크
- `document_type` - 문서 유형 (시장조사서, 제안서 등)
- `region` - 지역
- `project_name` - 프로젝트명
- `upload_points` - 업로드시 지급된 포인트
- `download_cost` - 다운로드 비용 (포인트)
- `download_count` - 다운로드 수
- `status` - 상태 (pending, approved, rejected)
- `is_premium_only` - 프리미엄 회원 전용 여부

### 📌 market_research_downloads (다운로드 기록)
**용도**: 누가 언제 어떤 자료를 다운로드했는지 추적  
**주요 정보**:
- `user_id` - 다운로드한 사용자
- `document_id` - 다운로드한 자료
- `points_spent` - 사용한 포인트
- `downloaded_at` - 다운로드 일시

### 📌 updates (업데이트 내역)
**용도**: 사이트 업데이트 내역 공지  
**주요 정보**:
- `title` - 업데이트 제목
- `content` - 업데이트 내용
- `version` - 버전 정보
- `update_type` - 업데이트 종류 (feature, bugfix, maintenance)

---

## ⚙️ 관리자 시스템

### 📌 admin_logs (관리자 활동 로그)
**용도**: 관리자가 수행한 모든 작업을 기록  
**주요 정보**:
- `admin_id` - 작업을 수행한 관리자
- `action` - 수행한 작업 (user_ban, point_adjust, content_delete 등)
- `target_type` - 작업 대상 (user, post, comment 등)
- `target_id` - 대상의 고유번호
- `details` - 작업 상세 내용
- `ip_address` - 관리자의 IP 주소
- `created_at` - 작업 일시

**실제 사용 예시**: "관리자 admin1이 2025-09-02 10:30에 user123을 7일간 정지시킴"

### 📌 site_settings (사이트 설정)
**용도**: 사이트 운영에 필요한 각종 설정값 저장  
**주요 정보**:
- `key` - 설정 키 (maintenance_mode, point_rate 등)
- `value` - 설정값
- `description` - 설정 설명
- `data_type` - 데이터 타입 (string, integer, boolean 등)
- `is_public` - 공개 여부

**실제 사용 예시**: "point_rate = 100 (1원당 1포인트), maintenance_mode = false"

### 📌 inquiries (고객 문의)
**용도**: 회원들이 보낸 문의사항 관리  
**주요 정보**:
- `user_id` - 문의한 사용자
- `admin_id` - 답변한 관리자
- `title` - 문의 제목
- `content` - 문의 내용
- `inquiry_type` - 문의 유형 (technical, billing, general 등)
- `status` - 처리 상태 (open, in_progress, resolved, closed)
- `admin_response` - 관리자 답변

---

## 🏆 뱃지 시스템

### 📌 badges (뱃지 정의)
**용도**: 시스템에서 사용할 수 있는 모든 뱃지 정의  
**주요 정보**:
- `id` - 뱃지 고유번호
- `name` - 뱃지 이름 ("출석왕", "글쓰기마스터" 등)
- `description` - 뱃지 설명
- `badge_type` - 뱃지 등급 (bronze, silver, gold, diamond, premium)
- `color` - 뱃지 색상
- `icon` - 뱃지 아이콘
- `conditions` - 획득 조건
- `points_reward` - 획득시 지급되는 포인트
- `is_active` - 활성화 여부

**현재 뱃지 예시**:
- "출석왕" - 30일 연속 출석시 획득
- "글쓰기마스터" - 게시글 100개 작성시 획득  
- "인기작가" - 게시글 좋아요 1000개 받을시 획득

---

## 🔐 보안 및 데이터 무결성

### ACID 트랜잭션 보장
모든 포인트 거래는 **원자성(Atomicity)**, **일관성(Consistency)**, **격리성(Isolation)**, **지속성(Durability)**이 보장됩니다.

**예시**: 포인트 선물하기
```
1. A사용자 포인트 차감
2. B사용자 포인트 증가
3. 거래 내역 2건 기록

→ 중간에 오류 발생시 전체 롤백되어 안전함
```

### 외래키 제약조건
- 모든 `user_id`는 실제 존재하는 사용자만 참조 가능
- 삭제시 연관 데이터 처리 방식 정의
- 데이터 무결성 자동 보장

### 체크 제약조건
- 포인트는 음수가 될 수 없음 (`current_points >= 0`)
- 회원 유형은 정해진 값만 입력 가능
- 출석일수는 1 이상이어야 함

---

## 📊 데이터 흐름도

### 포인트 적립 흐름
```
사용자 활동 발생 
    ↓
safe_earn_points() 함수 호출
    ↓
point_transactions 테이블에 거래 기록
    ↓  
point_balances 테이블에서 잔액 업데이트
    ↓
notifications 테이블에 알림 생성
```

### 출석체크 흐름
```
사용자가 출석체크 버튼 클릭
    ↓
process_daily_attendance() 함수 호출
    ↓
attendance_records 테이블에 출석 기록
    ↓
연속 출석일수에 따른 보너스 계산
    ↓
safe_earn_points()로 포인트 지급
    ↓
조건 달성시 뱃지 수여 (award_badge)
```

### 게시글 작성 흐름
```
사용자가 게시글 작성
    ↓
posts 테이블에 게시글 저장
    ↓
post_categories 테이블의 게시글 수 증가
    ↓
safe_earn_points()로 작성 포인트 지급
    ↓
작성 조건 달성시 뱃지 체크
```

---

## 🔧 핵심 함수 목록

### 포인트 관련 (가장 중요)
- **`safe_earn_points()`** - 안전한 포인트 적립
- **`safe_spend_points()`** - 안전한 포인트 사용  
- **`safe_transfer_points()`** - 안전한 포인트 이전
- **`get_user_point_balance()`** - 사용자 포인트 잔액 조회
- **`get_user_point_history()`** - 사용자 포인트 내역 조회

### 출석 관련
- **`process_daily_attendance()`** - 일일 출석 처리

### 사용자 관리
- **`create_signup_profile()`** - 회원가입시 프로필 생성
- **`award_badge()`** - 뱃지 수여
- **`create_notification()`** - 알림 생성

### 콘텐츠 관리
- **`increment_post_views()`** - 게시글 조회수 증가
- **`update_comment_count()`** - 댓글 수 업데이트
- **`update_like_count()`** - 좋아요 수 업데이트

---

## ❓ 자주 묻는 질문 (FAQ)

### Q1: 포인트가 잘못 계산될 위험은 없나요?
**A**: 모든 포인트 거래는 ACID 트랜잭션으로 처리되어 절대 오차가 발생하지 않습니다. 또한 모든 거래 내역이 point_transactions 테이블에 영구 보관되어 언제든 추적 가능합니다.

### Q2: 사용자가 탈퇴하면 포인트는 어떻게 되나요?
**A**: 사용자 삭제시 연관된 포인트 데이터도 함께 삭제됩니다. 단, 거래 내역은 감사 목적으로 보관됩니다.

### Q3: 출석체크를 중복으로 할 수 있나요?  
**A**: 불가능합니다. 같은 날짜에 대해 하나의 출석 기록만 생성되도록 제약조건이 설정되어 있습니다.

### Q4: 관리자가 포인트를 임의로 조작할 수 있나요?
**A**: 가능하지만 모든 관리자 활동은 admin_logs 테이블에 기록되어 추적됩니다.

### Q5: 데이터베이스가 꽉 찬다면?
**A**: 자동으로 오래된 로그 데이터를 아카이브하는 정책을 수립할 예정입니다.

---

## 🔄 업데이트 로그

### 2025-09-02 (v1.0) - 초기 구축 완료
- **전체 30개 테이블 생성**
- **포인트 시스템 5개 테이블 + 안전 함수 3개**
- **출석 시스템 3개 테이블 + 처리 함수 1개**  
- **커뮤니티 시스템 5개 테이블**
- **사용자 관리 4개 테이블**
- **관리자 시스템 3개 테이블**
- **알림 시스템 3개 테이블**
- **채용 시스템 2개 테이블**
- **자료 관리 3개 테이블**
- **뱃지 시스템 2개 테이블**

### 테스트 완료 항목
- ✅ 포인트 적립/사용/이전 테스트
- ✅ 출석체크 테스트
- ✅ 사용자 생성 테스트
- ✅ 트랜잭션 무결성 확인

---

## 📞 문의 및 지원

이 문서에 대한 문의사항이나 데이터베이스 관련 문제가 있을 경우, 개발팀에 연락해주세요.

**마지막 업데이트**: 2025년 9월 2일  
**문서 버전**: 1.0  
**데이터베이스 버전**: Production Ready v1.0

---

*이 문서는 WAVE SPACE 데이터베이스 구조 변경시마다 실시간으로 업데이트됩니다.*