<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>회원가입 디버그 테스트</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 800px;
            margin: 50px auto;
            padding: 20px;
        }
        .form-group {
            margin: 15px 0;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input, select {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        button {
            background: #0066ff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin: 10px 5px;
        }
        button:hover {
            background: #0052cc;
        }
        #result {
            margin-top: 20px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 4px;
            white-space: pre-wrap;
            font-family: monospace;
        }
        .success {
            background: #d4edda;
            color: #155724;
        }
        .error {
            background: #f8d7da;
            color: #721c24;
        }
        .info {
            background: #d1ecf1;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <h1>회원가입 디버그 테스트</h1>
    
    <div class="form-group">
        <label>아이디</label>
        <input type="text" id="username" value="testuser123">
    </div>
    
    <div class="form-group">
        <label>비밀번호</label>
        <input type="password" id="password" value="Test1234!">
    </div>
    
    <div class="form-group">
        <label>이름</label>
        <input type="text" id="fullName" value="테스트 사용자">
    </div>
    
    <div class="form-group">
        <label>이메일</label>
        <input type="email" id="email" value="testuser123@test.com">
    </div>
    
    <div class="form-group">
        <label>전화번호</label>
        <input type="text" id="phone" value="010-1234-5678">
    </div>
    
    <div class="form-group">
        <label>회원 유형</label>
        <select id="memberType">
            <option value="일반" selected>일반</option>
            <option value="실무자">실무자</option>
            <option value="기업">기업</option>
        </select>
    </div>
    
    <button onclick="testDirectSignup()">1. Supabase 직접 회원가입</button>
    <button onclick="testAuthService()">2. AuthService로 회원가입</button>
    <button onclick="checkAuthUsers()">3. Auth Users 확인</button>
    <button onclick="checkPublicUsers()">4. Public Users 확인</button>
    <button onclick="testRPCFunction()">5. RPC 함수 테스트</button>
    
    <div id="result"></div>
    
    <script>
        // Supabase 초기화
        const supabaseUrl = 'https://sishloxzcqapontycuyz.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNpc2hsb3h6Y3FhcG9udHljdXl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1NTA2MzAsImV4cCI6MjA3MDEyNjYzMH0.23aVcOSXDSvCi7yRtnCumy9knjIkL_mTAudSyubANZs';
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);
        
        function showResult(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            resultDiv.className = type;
            resultDiv.textContent = typeof message === 'object' ? JSON.stringify(message, null, 2) : message;
        }
        
        // 1. Supabase 직접 회원가입 테스트
        async function testDirectSignup() {
            try {
                showResult('Supabase 직접 회원가입 시도 중...', 'info');
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const email = document.getElementById('email').value;
                
                const { data, error } = await supabaseClient.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: {
                            username: username,
                            full_name: document.getElementById('fullName').value,
                            phone: document.getElementById('phone').value,
                            member_type: document.getElementById('memberType').value
                        }
                    }
                });
                
                if (error) {
                    showResult(`Auth 회원가입 실패:\n${JSON.stringify(error, null, 2)}`, 'error');
                    return;
                }
                
                showResult(`Auth 회원가입 성공!\nUser ID: ${data.user?.id}\nEmail: ${data.user?.email}`, 'success');
                
                // 프로필 생성 시도
                if (data.user) {
                    await createProfile(data.user.id);
                }
                
            } catch (error) {
                showResult(`오류 발생:\n${error.message}\n${error.stack}`, 'error');
            }
        }
        
        // 2. AuthService로 회원가입 테스트
        async function testAuthService() {
            try {
                showResult('AuthService 로딩 중...', 'info');
                
                // AuthService가 로드되었는지 확인
                if (!window.authService) {
                    // authService.js 동적 로드
                    await loadScript('js/config/supabase.js');
                    await loadScript('js/services/authService.js');
                    
                    // 초기화 대기
                    await new Promise(resolve => setTimeout(resolve, 1000));
                }
                
                if (!window.authService) {
                    showResult('AuthService를 로드할 수 없습니다.', 'error');
                    return;
                }
                
                showResult('AuthService로 회원가입 시도 중...', 'info');
                
                const result = await authService.signUp(
                    document.getElementById('username').value,
                    document.getElementById('password').value,
                    document.getElementById('fullName').value, // nickname
                    document.getElementById('fullName').value, // fullName
                    document.getElementById('email').value,
                    document.getElementById('phone').value,
                    document.getElementById('memberType').value,
                    {}, // additionalInfo
                    {}  // additionalData
                );
                
                if (result.success) {
                    showResult(`AuthService 회원가입 성공!\n${JSON.stringify(result, null, 2)}`, 'success');
                } else {
                    showResult(`AuthService 회원가입 실패:\n${result.error}`, 'error');
                }
                
            } catch (error) {
                showResult(`오류 발생:\n${error.message}\n${error.stack}`, 'error');
            }
        }
        
        // 3. Auth Users 확인
        async function checkAuthUsers() {
            try {
                showResult('Auth Users 조회 중...', 'info');
                
                // 최근 생성된 사용자 확인 (RPC 함수 사용)
                const { data, error } = await supabaseClient
                    .rpc('get_recent_auth_users');
                
                if (error) {
                    // RPC 함수가 없으면 현재 사용자만 확인
                    const { data: { user } } = await supabaseClient.auth.getUser();
                    if (user) {
                        showResult(`현재 로그인된 사용자:\nID: ${user.id}\nEmail: ${user.email}`, 'info');
                    } else {
                        showResult('로그인된 사용자가 없습니다.', 'info');
                    }
                } else {
                    showResult(`Auth Users:\n${JSON.stringify(data, null, 2)}`, 'info');
                }
                
            } catch (error) {
                showResult(`오류 발생:\n${error.message}`, 'error');
            }
        }
        
        // 4. Public Users 확인
        async function checkPublicUsers() {
            try {
                showResult('Public Users 조회 중...', 'info');
                
                const { data, error } = await supabaseClient
                    .from('users')
                    .select('*')
                    .order('created_at', { ascending: false })
                    .limit(5);
                
                if (error) {
                    showResult(`조회 실패:\n${JSON.stringify(error, null, 2)}`, 'error');
                } else {
                    showResult(`Public Users (최근 5개):\n${JSON.stringify(data, null, 2)}`, 'info');
                }
                
            } catch (error) {
                showResult(`오류 발생:\n${error.message}`, 'error');
            }
        }
        
        // 5. RPC 함수 테스트
        async function testRPCFunction() {
            try {
                showResult('RPC 함수 테스트 중...', 'info');
                
                // 현재 로그인된 사용자 확인
                const { data: { user } } = await supabaseClient.auth.getUser();
                
                if (!user) {
                    showResult('먼저 회원가입을 하세요.', 'error');
                    return;
                }
                
                const { data, error } = await supabaseClient
                    .rpc('create_signup_profile', {
                        p_auth_user_id: user.id,
                        p_username: document.getElementById('username').value,
                        p_full_name: document.getElementById('fullName').value,
                        p_email: document.getElementById('email').value,
                        p_phone: document.getElementById('phone').value,
                        p_member_type: document.getElementById('memberType').value
                    });
                
                if (error) {
                    showResult(`RPC 함수 실패:\n${JSON.stringify(error, null, 2)}`, 'error');
                } else {
                    showResult(`RPC 함수 성공:\n${JSON.stringify(data, null, 2)}`, 'success');
                }
                
            } catch (error) {
                showResult(`오류 발생:\n${error.message}`, 'error');
            }
        }
        
        // 프로필 생성 헬퍼 함수
        async function createProfile(authUserId) {
            try {
                showResult('프로필 생성 중...', 'info');
                
                const { data, error } = await supabaseClient
                    .rpc('create_signup_profile', {
                        p_auth_user_id: authUserId,
                        p_username: document.getElementById('username').value,
                        p_full_name: document.getElementById('fullName').value,
                        p_email: document.getElementById('email').value,
                        p_phone: document.getElementById('phone').value,
                        p_member_type: document.getElementById('memberType').value
                    });
                
                if (error) {
                    showResult(`프로필 생성 실패:\n${JSON.stringify(error, null, 2)}`, 'error');
                } else {
                    showResult(`프로필 생성 성공:\n${JSON.stringify(data, null, 2)}`, 'success');
                }
                
            } catch (error) {
                showResult(`프로필 생성 오류:\n${error.message}`, 'error');
            }
        }
        
        // 스크립트 동적 로드
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }
    </script>
</body>
</html>