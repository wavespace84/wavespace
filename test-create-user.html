<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>테스트 사용자 생성</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <h1>테스트 사용자 생성</h1>
    <button onclick="createTestUser()">test1 사용자 생성</button>
    <div id="result"></div>

    <script>
        // Supabase 초기화
        const supabaseUrl = 'https://sishloxzcqapontycuyz.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNpc2hsb3h6Y3FhcG9udHljdXl6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTQ1NTA2MzAsImV4cCI6MjA3MDEyNjYzMH0.23aVcOSXDSvCi7yRtnCumy9knjIkL_mTAudSyubANZs';
        const { createClient } = supabase;
        const supabaseClient = createClient(supabaseUrl, supabaseKey);

        async function createTestUser() {
            const resultDiv = document.getElementById('result');
            
            try {
                // 1. Auth에 사용자 생성
                const { data: authData, error: authError } = await supabaseClient.auth.signUp({
                    email: 'test1@example.com',  // 실제 이메일 형식 사용
                    password: 'test1234!',
                    options: {
                        data: {
                            username: 'test1',
                            full_name: '테스트 사용자1',
                            actual_email: 'test1@example.com'
                        }
                    }
                });

                if (authError) {
                    resultDiv.innerHTML = `<p style="color: red;">Auth 생성 실패: ${authError.message}</p>`;
                    console.error('Auth error:', authError);
                    return;
                }

                console.log('Auth 사용자 생성됨:', authData);

                // 2. users 테이블에 프로필 생성
                if (authData.user) {
                    const { data: profileData, error: profileError } = await supabaseClient
                        .from('users')
                        .insert([{
                            auth_user_id: authData.user.id,
                            username: 'test1',
                            full_name: '테스트 사용자1',
                            email: 'test1@example.com',
                            phone: '010-1234-5678',
                            member_type: '일반',
                            points: 1000,
                            level: 1,
                            role: 'user'
                        }]);

                    if (profileError) {
                        // RPC 함수로 시도
                        const { data: rpcResult, error: rpcError } = await supabaseClient
                            .rpc('create_user_profile', {
                                p_auth_user_id: authData.user.id,
                                p_username: 'test1',
                                p_full_name: '테스트 사용자1',
                                p_email: 'test1@example.com',
                                p_phone: '010-1234-5678',
                                p_member_type: '일반'
                            });

                        if (rpcError) {
                            resultDiv.innerHTML = `<p style="color: orange;">Auth 생성 성공, 프로필 생성 실패: ${rpcError.message}</p>`;
                            console.error('Profile error:', rpcError);
                        } else {
                            resultDiv.innerHTML = `<p style="color: green;">test1 사용자가 성공적으로 생성되었습니다! (RPC)</p>
                                <p>아이디: test1</p>
                                <p>비밀번호: test1234!</p>`;
                        }
                    } else {
                        resultDiv.innerHTML = `<p style="color: green;">test1 사용자가 성공적으로 생성되었습니다!</p>
                            <p>아이디: test1</p>
                            <p>비밀번호: test1234!</p>`;
                    }
                }
            } catch (error) {
                resultDiv.innerHTML = `<p style="color: red;">오류: ${error.message}</p>`;
                console.error('Error:', error);
            }
        }
    </script>
</body>
</html>